---
title: 通过公式计算字段值
---
公式是从其他字段、表达式或值派生其值的一种算法。公式可帮助您根据其他字段自动计算一个字段的值。

## 在哪些地方可以使用公式?

华炎魔方的许多地方都可以使用公式。开始使用公式之前，请了解其用法的差别。

- **批准过程：** 定义记录必须满足才能进入批准过程的条件。
- **批准步骤：** 定义记录必须满足才能进入批准步骤的条件。
- **字段默认值：** 在用户创建记录时向自定义字段应用一个值。使用公式可以定义默认值。用户可以更改默认值。默认值可以由使用您指定的值、合并字段或表达式的公式确定。
- **公式字段：** 使用您指定的值、合并字段或表达式。自动计算自定义字段的值。用户不能更改公式字段的值。
- **验证规则：** 防止用户在标准/自定义字段中输入无效值。验证规则可以基于公式，并在用户输入无效值时，向用户显示出错消息。
- **字段更新：** 自动将字段值更改为您指定的值。公式中可以包括其他值、合并字段或表达式。可以将字段更新设置为因工作流规则或批准过程而发生。
- **工作流规则：** 定义记录触发工作流规则时必须满足的条件。

常用公式过程

用法 | 何时执行？ | 只读？ | 可以指定空处理？
:- | :-: | :-: | :-:
**批准过程** | 记录提交待批准 | 不适用 | 否
**批准步骤** | 记录提交待批准 | 不适用 | 否
**字段默认值** | 创建记录时 | 否 | 否
**公式字段** | 记录被保存后 | 是 | 是
**验证规则** | 记录被保存前 | 不适用 | 否
**字段更新** | 工作流或批准过程中 | 不适用 | 否
**工作流规则** | 保存记录时 | 不适用 | 否

## 公式数据类型

公式的数据类型决定预期从公式返回的数据的类型。

- **文本：** 返回字符串。除公式输出外，若还要显示文本，请将该文本放入引号中。对文本、多行文本、网址、邮件地址和自动编号等字段使用文本数据类型。
- **布尔：** 返回 true（真） 或false（假）。该字段在记录详细信息页面和报表中显示为复选框。使用 true 作为选中值，使用 false 作为未选中值。
- **币种：**  只能输入数值内容，默认2位小数，也可以指定小数位数。
- **日期：** 返回代表日历中某一天的日期。当前日期可通过在公式中调用内部函数 TODAY() 获得。
- **日期时间：** 返回表示时间中某一时刻的数据。日期/时间字段包括日期，还包括由小时、分钟和秒组成的一天中的时刻。您可以使用 NOW() 函数在公式中插入当前日期和时间。
- **数字：** 返回正负整数或小数（最多 18 位）。华炎魔方对公式字段使用四舍五入平分规则。例如，12.345 变为 12.35 和 -12.345 变为 -12.35。
- **百分比：** 返回后跟百分号的百分比格式数字（最多 18 位）。百分比数据存储为小数，值为除以 100 后得到的小数，即 90% 等于 0.90。
- **时间（暂不支持）：** 返回表示时间中某一时刻的数据，没有日期。时间字段包含小时、分钟、秒和毫秒的时间。您可以使用 TIMENOW() 函数在公式中插入当前日期。

## 公式中的元素

公式可以包含对字段值、运算符、函数、文字表示值或其他公式的引用。使用任意或所有这些元素构建公式。

### 文字表示值

您输入的未经计算或更改的文本字符串或数字。

例如，如果您有一个总是要乘以金额的 2% 的值，公式将会包含该金额的 2% 的文字表示值：

```js
ROUND((金额*0.02), 2)
```

此示例包含公式每个可能的部分：

- 一个称为 ROUND 的函数，用于返回一个数值舍入为指定小数位数的数值。
- 名为“金额”的字段引用。
- 一个运算符 *，告诉公式生成器用文字表示值 0.02 乘以金额字段的值。
- 一个文字表示数值 0.02。对所有百分数使用小数值。要在您的公式中包括实际文本，应将其括在引号内。
- 此公式中的最后一个数字 2 是确定要返回的小数位数的 ROUND 函数所需的输入。

### 函数

函数即系统定义的公式，可能需要您的输入值，并返回一个或几个值。例如，TODAY() 不需要输入值，但会返回当前日期。TEXT(value) 函数需要您输入百分比、数字或货币并返回文本。

### 运算符

一个符号，指定要执行的计算类型或其执行顺序。例如，“+”号指定两个值应相加。左括号和右括号指定想要先计算的表达式。

### 字段引用

使用合并字段引用另一个自定义字段或标准字段的值。

合并字段的语法对于标准字段是 `field_name`，对于自定义字段是 `field_name__c`。相关对象上合并字段的语法是 `reference_to_field_name.field_name`，必要时可在您的公式中插入合并字段，并且理论上支持无限层次的扩展引用，比如三层引用写法为`reference_to1_field_name.reference_to2_field_name.field_name`。

支持引用当前登录用户相关字段，写法是以`$user`开头来表示当前登录用户的引用，并用点符号来连接后续要扩展引用的属性，比如`$user.name`表示引用当前用户的名称，`$user.organization.name`表示引用当前用户所属组织的名称。

要引用关联字段指向的记录id只要用点符号来连接`_id`即可，比如`reference_to_field_name._id`，`$user._id`

### 评论（暂未支持）

公式中的注解，以反斜杠加上星号 (/*) 开头，以星号加上反斜杠 (*/) 结尾。例如，

```js
/*这是公式注解*/
```

处理公式时会忽略评论。

评论用于向查看公式定义的人解释公式的某些部分。例如：

```js
AND( 
/*competitor 字段是必需的，请检查该字段是否为空 * /
LEN(Competitor__c) = 0，
)
```

评论内容支持`/*`这两个字符以外的任意字符，当评论比较复杂时，可以写多行文本来评论，例如：

```js
AND( 
/*competitor 字段是必需的，
请检查该字段是否为空 。
更多注释说明* /
LEN(Competitor__c) = 0，
)
```

嵌套评论会产生语法错误。例如，您无法保存具有以下语句的公式：

```js
/* /* comment */ */
```

### 公式中的运算符和函数

在构建公式时可以使用很多运算符和函数，请参考：[公式中的运算符和函数](/help/formula/functions)。

## 公式最佳实践

在华炎魔方中，您如果需要构建更复杂的公式，请参考这些提示，以帮您筹划公式逻辑，并更轻松地对错误进行故障排除。

### 将每个函数放在单独行上

轻松培养将整个公式保持在一行中的习惯，特别是在公式较小时。将每个函数放在各自的行上，这将使公式更易于读取和排除故障。这些示例显示相同公式，一个是没有换行符，另一个是将每个函数放在单独行上。

```js
IF(AND(ISBLANK(myDate_c),active_c=true),"Missing Date","Not Applicable")
```

```js
IF(
AND(
ISBLANK(myDate_c),
active_c=true
),
"Missing Date",
"Not Applicable"
)
```

### 括号中的缩进部分

在公式涉及多个函数时，缩进有助于在视觉上隔离每个函数，并更容易找出错误，例如错放字符。

在此示例中，通过缩进，您将看到公式的大部分在单个 IF 语句中，并且 AND 语句包含两个函数。在 AND 语句中，函数 ISBLANK 包含在括号内。

```js
IF(
  AND(
    ISBLANK(myDate_c),
    active_c=true
  ),
  "Missing Date",
  "Not Applicable"
)
```

缩进也可帮您集中注意力解决错误。通过采用平面布局，难以发现在 ISBLANK 语句后包含的额外 ")”，且没有关于如何构建公式的视觉提示。

```js
IF(
AND(
ISBLANK(myDate_c)
),
active_c=true
),
"Missing Date",
"Not Applicable"
)
```

通过缩进布局，您可以轻松查看公式的结构。我们可以快速找到并移除多余字符，以便正确格式化 AND 语句。

```js
IF(
  AND(
    ISBLANK(myDate_c)
    ),
    active_c=true
  ),
  "Missing Date",
  "Not Applicable"
)
```

### 使用大写字母写入语句和函数名称

此处所有示例对语句和函数名称使用大写字母，例如 IF、AND 和 ISBLANK，对这些术语使用大写字母可以明确区分函数与参数，并使复杂公式更容易辨别。
